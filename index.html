<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestion LONACI - Cloud Sync</title>

<style>
:root{
  --primary:#1e40af;
  --bg:#f1f5f9;
  --card:#ffffff;
  --success:#059669;
  --warning:#7c3aed;
}
body{margin:0;font-family:Arial, sans-serif;background:var(--bg)}
header{background:var(--primary);color:#fff;padding:1rem;text-align:center;position:relative}
nav{display:flex;gap:.5rem;padding:.5rem;background:#e5e7eb}
nav button{flex:1;padding:.6rem;border:none;border-radius:6px;cursor:pointer}
nav button.active{background:var(--primary);color:white}
section{display:none;padding:1rem}
section.active{display:block}
.card{background:white;padding:1rem;border-radius:8px;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
input,select,button{width:100%;padding:.5rem;margin-top:.4rem;border:1px solid #ccc;border-radius:6px}
button{cursor:pointer; font-weight:bold}
.btn-cloud{background-color: var(--success); color: white; border: none; margin-top: 10px}
.btn-auth{background-color: var(--primary); color: white; border: none}
.btn-load{background-color: var(--warning); color: white; border: none}
.btn-local{background-color: #64748b; color: white; border: none}
table{width:100%;border-collapse:collapse;margin-top:.6rem}
th,td{border-bottom:1px solid #e5e7eb;padding:.4rem;text-align:center}
.action.delete{color:#dc2626; cursor:pointer; font-weight:bold}
.burger{position:absolute;left:1rem;top:1rem;font-size:1.5rem;cursor:pointer;display:none}
@media(max-width:768px){
  nav{display:none;flex-direction:column}
  nav.active{display:flex}
  .burger{display:block}
}
</style>
</head>
<body>

<header>
  <span class="burger" onclick="toggleMenu()">‚ò∞</span>
  Application de Gestion Commerciale
</header>

<nav>
  <button class="active" onclick="tab('dashboard', this)">Dashboard</button>
  <button onclick="tab('params', this)">Param√®tres</button>
  <button onclick="tab('journal', this)">Journal</button>
  <button onclick="tab('bilan', this)">Bilan</button>
</nav>

<section id="dashboard" class="active">
  <div class="card"><h3>Rapport Journalier</h3><p id="dailyReport"></p></div>
  <div class="card"><h3>Rapport Hebdomadaire</h3><p id="weeklyReport"></p></div>
  <div class="card"><h3>Rapport Mensuel</h3><p id="monthlyReport"></p></div>
  <div class="card"><h3>Meilleur Agent</h3><p id="bestAgent"></p></div>
</section>

<section id="params">
  <div class="card">
    <h3>‚òÅÔ∏è Sauvegarde Cloud (Google Drive)</h3>
    <button id="auth_btn" class="btn-auth" onclick="handleAuth()">1. Connexion Google</button>
    <button id="save_cloud_btn" class="btn-cloud" style="display:none" onclick="saveToDrive()">2. Enregistrer sur le Cloud</button>
    <button id="load_cloud_btn" class="btn-load" style="display:none" onclick="loadFromDrive()">3. Restaurer du Cloud</button>
    <p id="cloud_status" style="font-size:0.8rem; color:gray; text-align:center">Statut : Non connect√©</p>
  </div>

  <div class="card">
    <h3>üíæ Sauvegarde Locale (Secours)</h3>
    <button class="btn-local" onclick="exportLocal()">T√©l√©charger Backup</button>
    <p style="font-size:0.7rem; color:gray">Utile si la connexion Google √©choue.</p>
  </div>

  <div class="card">
    <h3>Services</h3>
    <input id="serviceInput" placeholder="Nom service">
    <button onclick="addService()">Ajouter</button>
    <table><thead><tr><th>Nom</th><th>Action</th></tr></thead><tbody id="serviceTable"></tbody></table>
  </div>

  <div class="card">
    <h3>Agents</h3>
    <input id="agentCode" placeholder="Code">
    <input id="agentName" placeholder="Nom">
    <select id="agentService"></select>
    <input type="number" id="agentRate" placeholder="Taux %">
    <button onclick="addAgent()">Ajouter</button>
    <table><thead><tr><th>Code</th><th>Nom</th><th>Taux</th><th>Action</th></tr></thead><tbody id="agentTable"></tbody></table>
  </div>
</section>

<section id="journal">
  <div class="card">
    <h3>Saisie</h3>
    <input type="number" id="jDay" min="1" max="31" placeholder="Jour">
    <select id="jMonth"></select>
    <input type="number" id="jYear" value="2026">
    <select id="jService" onchange="updateAgentSelect()"></select>
    <select id="jAgent"></select>
    <input type="number" id="jAmount" placeholder="Montant">
    <button onclick="addTransaction()">Enregistrer</button>
  </div>
  <div class="card">
    <table><thead><tr><th>Date</th><th>Service</th><th>Agent</th><th>Montant</th></tr></thead><tbody id="journalTable"></tbody></table>
  </div>
</section>

<section id="bilan">
  <div class="card">
    <h3>Bilan Mensuel</h3>
    <select id="mMonth"></select>
    <input id="mYear" value="2026">
    <button onclick="monthly()">G√©n√©rer</button>
    <table><thead><tr><th>Service</th><th>Recettes</th><th>Commissions</th></tr></thead><tbody id="bilanMonthTable"></tbody></table>
  </div>
</section>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

<script>
// --- CONFIGURATION GOOGLE ---
const API_KEY = 'AIzaSyBMjWoe9Y3WnTLPbh3nqSxoG799Tj9tu9M';
const CLIENT_ID = '642215240533-ko9t9ulmq5igcqv3csuhvuaptkmc96nt.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let gapiInited = false;

function gapiLoaded() { gapi.load('client', async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
    gapiInited = true;
});}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES, callback: (resp) => {
            if (resp.error) return;
            document.getElementById('save_cloud_btn').style.display = 'block';
            document.getElementById('load_cloud_btn').style.display = 'block';
            document.getElementById('auth_btn').style.display = 'none';
            document.getElementById('cloud_status').textContent = "Connect√© : Sauvegarde pr√™te";
        },
    });
}

function handleAuth() { tokenClient.requestAccessToken({prompt: 'consent'}); }

// LOGIQUE APPLICATION
const months=["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"];
let services=JSON.parse(localStorage.services||"[]");
let agents=JSON.parse(localStorage.agents||"[]");
let journal=JSON.parse(localStorage.journal||"[]");

function save(){
    localStorage.services=JSON.stringify(services);
    localStorage.agents=JSON.stringify(agents);
    localStorage.journal=JSON.stringify(journal);
}

// CLOUD ACTIONS
async function saveToDrive() {
    const data = JSON.stringify({ services, agents, journal });
    const metadata = { 'name': 'lonaci_db.json', 'mimeType': 'application/json' };
    const file = new Blob([data], {type: 'application/json'});
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    form.append('file', file);

    try {
        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
            body: form
        });
        if(res.ok) alert("‚úÖ Enregistr√© sur Google Drive !");
        else alert("Erreur : V√©rifiez les origines autoris√©es dans Google Cloud.");
    } catch (e) { alert("√âchec de connexion au serveur."); }
}

async function loadFromDrive() {
    const response = await gapi.client.drive.files.list({ q: "name='lonaci_db.json'", fields: 'files(id)' });
    if (response.result.files.length > 0) {
        const res = await gapi.client.drive.files.get({ fileId: response.result.files[0].id, alt: 'media' });
        if(confirm("√âcraser les donn√©es locales par la sauvegarde Cloud ?")){
            services = res.result.services || [];
            agents = res.result.agents || [];
            journal = res.result.journal || [];
            save(); render();
        }
    } else { alert("Aucun fichier trouv√© sur le Cloud."); }
}

function exportLocal() {
    const blob = new Blob([JSON.stringify({services, agents, journal})], {type: 'application/json'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "lonaci_local_backup.json";
    a.click();
}

// UI LOGIC
function tab(id, btn){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    if(btn) btn.classList.add("active");
}

function toggleMenu(){ document.querySelector("nav").classList.toggle("active"); }

function addService(){
    const n = serviceInput.value.trim();
    if(n){ services.push(n); serviceInput.value=""; save(); render(); }
}

function addAgent(){
    const a = {code: agentCode.value, name: agentName.value, service: agentService.value, rate: Number(agentRate.value)};
    if(a.code && a.name){ agents.push(a); save(); render(); }
}

function updateAgentSelect(){
    jAgent.innerHTML = agents.filter(a=>a.service===jService.value).map(a=>`<option value="${a.code}">${a.name}</option>`).join("");
}

function addTransaction(){
    const a = agents.find(x=>x.code===jAgent.value);
    const d = `${jDay.value}/${Number(jMonth.value)+1}/${jYear.value}`;
    if(a && jAmount.value){
        journal.push({date: d, service: a.service, agent: a.name, amount: Number(jAmount.value), commission: Number(jAmount.value)*a.rate/100});
        save(); render();
    }
}

function render(){
    serviceTable.innerHTML = services.map((s,i)=>`<tr><td>${s}</td><td onclick="services.splice(${i},1);save();render()" class="action delete">‚úñ</td></tr>`).join("");
    agentService.innerHTML = services.map(s=>`<option>${s}</option>`).join("");
    jService.innerHTML = services.map(s=>`<option>${s}</option>`).join("");
    agentTable.innerHTML = agents.map((a,i)=>`<tr><td>${a.code}</td><td>${a.name}</td><td>${a.rate}%</td><td onclick="agents.splice(${i},1);save();render()" class="action delete">‚úñ</td></tr>`).join("");
    jMonth.innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
    mMonth.innerHTML = jMonth.innerHTML;
    journalTable.innerHTML = journal.slice(-10).reverse().map(j=>`<tr><td>${j.date}</td><td>${j.service}</td><td>${j.agent}</td><td>${j.amount}</td></tr>`).join("");
    updateAgentSelect();
}

render();
</script>
</body>
</html>